<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿ºå°‚ç”¨ãƒã‚¹ãƒŠãƒ“ v14.1 (Final Polish)</title>
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" href="apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --bg-primary: #0c0c0e;
      --bg-secondary: #111115;
      --bg-tertiary: #1a1a20;
      --bg-card: rgba(255, 255, 255, 0.04);
      --bg-glass: rgba(255, 255, 255, 0.08);
      --bg-hover: rgba(255, 255, 255, 0.06);
      
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      
      --border: rgba(255, 255, 255, 0.08);
      --border-focus: rgba(59, 130, 246, 0.4);
      
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.25);
      --shadow-glow: 0 0 30px rgba(59, 130, 246, 0.15);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
      
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .title {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* Mode Switcher */
    .mode-switcher {
      display: flex;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 4px;
      margin-bottom: 24px;
      backdrop-filter: blur(20px);
    }

    .mode-button {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }

    .mode-button.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
      transform: scale(1.02);
    }

    .mode-button:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Clock */
    .clock {
      text-align: center;
      margin-bottom: 32px;
    }

    .current-time {
      font-size: clamp(2rem, 6vw, 2.5rem);
      font-weight: 700;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
      text-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
    }

    /* Main Card */
    .main-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .main-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      opacity: 0.5;
    }

    .main-card.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      flex-direction: column;
      gap: 16px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--bg-tertiary);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Itinerary */
    .main-countdown {
      text-align: center;
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: clamp(1.5rem, 5vw, 1.75rem);
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 32px;
      min-height: 1.5em;
    }

    .itinerary {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .itinerary-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      transition: all 0.3s ease;
    }

    .itinerary-step:hover {
      background: var(--bg-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .step-time {
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: clamp(1.75rem, 6vw, 2.25rem);
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      margin-bottom: 4px;
    }

    .step-location {
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .itinerary-connector {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      position: relative;
    }

    .connector-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .connector-text {
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: 0.875rem;
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }

    /* Direct Bus Info */
    .departure-time-main {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 800;
      text-align: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
    }

    .time-remaining-direct {
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 600;
      text-align: center;
      min-height: 1.5em;
      margin-bottom: 24px;
    }

    .details-direct {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .detail-tag {
      padding: 8px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .detail-tag:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
      border: none;
      margin: 24px 0;
    }

    .second-bus {
      text-align: center;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }

    .second-bus-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .second-bus-time {
      font-weight: 600;
      color: var(--accent);
    }

    .second-countdown {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Lower Section */
    .lower-section {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-button {
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .filter-button:hover {
      background: var(--bg-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .filter-button.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      box-shadow: var(--shadow-glow);
    }

    .route-filter-button {
      padding: 8px 16px;
      font-size: 0.8125rem;
    }

    /* Bus List */
    .upcoming-buses {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bus-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .bus-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
    }

    .bus-item:hover {
      background: var(--bg-hover);
      transform: translateX(8px);
      box-shadow: var(--shadow-lg);
    }

    .bus-time {
      /* â˜…â˜…â˜… æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã â˜…â˜…â˜… */
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .bus-route {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Footer */
    footer {
      margin-top: 64px;
      padding: 32px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      text-align: center;
      backdrop-filter: blur(20px);
    }

    footer p {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin: 8px 0;
      line-height: 1.5;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    footer a:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Back to Top Button */
    .back-to-top {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 48px;
      height: 48px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      display: none;
    }

    .back-to-top:hover {
      background: var(--primary-hover);
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      body {
        padding: 16px;
      }
      
      .main-card {
        padding: 24px;
      }
      
      .button-container {
        gap: 8px;
      }
      
      .filter-button {
        padding: 10px 16px;
        font-size: 0.8125rem;
      }
    }

    /* Dark mode enhancements */
    @media (prefers-color-scheme: dark) {
      :root {
        --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.2);
      }
    }

    /* Animation utilities */
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">ä¿ºå°‚ç”¨ãƒã‚¹ãƒŠãƒ“</h1>
      <p class="subtitle">v14.1 Polished</p>
    </div>
    
    <div class="mode-switcher">
      <button class="mode-button active" data-mode="to_kamiooka">å—é™µæ–¹é¢ â†’ ä¸Šå¤§å²¡</button>
      <button class="mode-button" data-mode="from_kamiooka">ä¸Šå¤§å²¡ â†’ å¤æ³‰</button>
    </div>
    
    <div class="clock">
      <div class="current-time" id="currentTime">--:--:--</div>
    </div>
    
    <div class="main-card loading" id="nextBusResult">
      <div class="loading-spinner"></div>
      <div>èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <div class="lower-section" id="lowerSection">
      <div class="button-container" id="busStopContainer">
        <!-- â˜…â˜…â˜… ãƒœã‚¿ãƒ³ã‚’å¾©æ´»ã•ã›ã‚‹ â˜…â˜…â˜… -->
        <button class="filter-button" data-stop="yokodaikita">æ´‹å…‰å°åŒ—å£</button>
        <button class="filter-button" data-stop="hinosyo">æ—¥é‡å°å­¦æ ¡å‰</button>
        <button class="filter-button" data-stop="hinotyuokouen">æ—¥é‡ä¸­å¤®å…¬åœ’å…¥å£</button>
      </div>
      
      <div class="button-container" id="routeFilterContainer">
        <button class="filter-button route-filter-button" data-route="all">ã™ã¹ã¦</button>
        <button class="filter-button route-filter-button" data-route="å¸‚å–¶111">å¸‚å–¶111</button>
        <button class="filter-button route-filter-button" data-route="å¸‚å–¶64">å¸‚å–¶64</button>
        <button class="filter-button route-filter-button" data-route="å¸‚å–¶2">å¸‚å–¶2</button>
      </div>
      
      <div class="upcoming-buses" id="upcomingBusesResult"></div>
    </div>
  </div>
  
  <footer>
    <p>æœ€çµ‚æ›´æ–°æ—¥: 2025/08/09</p>
    <p>ã“ã®æ™‚åˆ»ãŒé–“é•ã£ã¦ã„ã¦ã‚‚è²¬ä»»ã¯è² ã„ã‹ã­ã¾ã™ã€‚<br>
    æ­£ç¢ºãªæƒ…å ±ã¯<a href="https://www.city.yokohama.lg.jp/kotsu/bus/" target="_blank" rel="noopener noreferrer">æ¨ªæµœå¸‚å–¶ãƒã‚¹å…¬å¼ã‚µã‚¤ãƒˆ</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
  </footer>
  
  <button class="back-to-top" id="backToTopButton">â†‘</button>

  <script>
    const API_URL = "./bus_data.json";
    const TRANSFER_BUFFER_MINUTES = 5;
    let allBusData = [], optimalPair = null, nextBusFromKamiooka = null, secondBusFromKamiooka = null;
    // â˜…â˜…â˜… busStopNames ã« hinotyuokouen ã‚’å¾©æ´» â˜…â˜…â˜…
    const busStopNames = { yokodaikita: "æ´‹å…‰å°åŒ—å£", hinosyo: "æ—¥é‡å°å­¦æ ¡å‰", hinotyuokouen: "æ—¥é‡ä¸­å¤®å…¬åœ’å…¥å£", kamioooka: "ä¸Šå¤§å²¡é§…å‰", kosen: "å¤æ³‰" };
    let currentMode = 'to_kamiooka', currentStopId = null, currentRouteFilter = 'all';
    
    const modeButtons = document.querySelectorAll('.mode-button');
    const lowerSection = document.getElementById('lowerSection');
    const busStopContainer = document.getElementById('busStopContainer');
    const routeFilterContainer = document.getElementById('routeFilterContainer');
    const currentTimeDiv = document.getElementById('currentTime');
    const busStopButtons = document.querySelectorAll('#busStopContainer .filter-button');
    const routeFilterButtons = document.querySelectorAll('#routeFilterContainer .filter-button');
    const nextBusResultDiv = document.getElementById('nextBusResult');
    const upcomingBusesResultDiv = document.getElementById('upcomingBusesResult');

    document.addEventListener('DOMContentLoaded', async () => {
      setInterval(() => {
        const now = new Date();
        currentTimeDiv.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      }, 1000);
      
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        const today = new Date();
        const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
        
        allBusData = data.map(bus => {
          const [h, min] = bus.time.split(':').map(Number);
          bus.departureTimestamp = new Date(y, m, d, h, min).getTime();
          if (bus.arrivalTime) {
            const [ah, amin] = bus.arrivalTime.split(':').map(Number);
            bus.arrivalTimestamp = new Date(y, m, d, ah, amin).getTime();
          }
          return bus;
        }).sort((a, b) => a.departureTimestamp - b.departureTimestamp);
        
        nextBusResultDiv.classList.remove('loading');
        findAndDisplay();
        updateLowerSection();
        
        setInterval(updateCountdowns, 1000);
        setInterval(findAndDisplay, 30000);
        
        document.querySelector('.filter-button[data-route="all"]').classList.add('active');
      } catch (error) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        nextBusResultDiv.classList.remove('loading');
        nextBusResultDiv.innerHTML = '<div style="text-align: center; color: var(--error);">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    });

    modeButtons.forEach(button => {
      button.addEventListener('click', () => {
        modeButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentMode = button.dataset.mode;
        findAndDisplay();
        updateLowerSection();
      });
    });

    function updateLowerSection() {
      if (currentMode === 'to_kamiooka') {
        busStopContainer.style.display = 'flex';
        routeFilterContainer.style.display = 'flex';
        if (!currentStopId) {
          upcomingBusesResultDiv.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 20px;">ä¸Šã®ãƒã‚¹åœãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©³ç´°ã‚’è¡¨ç¤º</p>`;
        } else {
          displayUpcomingBuses();
        }
      } else {
        busStopContainer.style.display = 'none';
        routeFilterContainer.style.display = 'none';
        displayKamiookaBusList();
      }
    }
    
    function findAndDisplay() {
      if (currentMode === 'to_kamiooka') {
        optimalPair = findOptimalTransfer();
        displayTransferInfo();
      } else {
        const now = new Date().getTime();
        const available = allBusData.filter(b => b.busStop === 'kamioooka' && b.departureTimestamp >= now);
        nextBusFromKamiooka = available[0] || null;
        secondBusFromKamiooka = available[1] || null;
        displayDirectBusInfo();
      }
    }

    function findOptimalTransfer() {
      const now = new Date().getTime();
      const transferBufferMs = TRANSFER_BUFFER_MINUTES * 60 * 1000;
      // â˜…â˜…â˜… ä¹—ã‚Šæ›ãˆæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã¯ hinotyuokouen ã‚’é™¤å¤–ã—ãŸã¾ã¾ (ã“ã‚ŒãŒæ­£ã—ã„æŒ™å‹•) â˜…â˜…â˜…
      const futureToKamiooka = allBusData.filter(b => ['yokodaikita', 'hinosyo'].includes(b.busStop) && b.departureTimestamp >= now);
      const futureFromKamiooka = allBusData.filter(b => b.busStop === 'kamioooka' && b.departureTimestamp >= now);
      
      if (!futureToKamiooka.length || !futureFromKamiooka.length) return null;
      
      for (const departureBus of futureToKamiooka) {
        if (!departureBus.arrivalTimestamp) continue;
        const connectingBus = futureFromKamiooka.find(transferBus => 
          transferBus.departureTimestamp >= (departureBus.arrivalTimestamp + transferBufferMs)
        );
        if (connectingBus) return { departureBus, connectingBus };
      }
      return null;
    }

    function displayTransferInfo() {
      if (optimalPair) {
        const { departureBus, connectingBus } = optimalPair;
        const waitTimeMin = Math.floor((connectingBus.departureTimestamp - departureBus.arrivalTimestamp) / (1000 * 60));
        
        nextBusResultDiv.innerHTML = `
          <div class="main-countdown" id="main-countdown"></div>
          <div class="itinerary">
            <div class="itinerary-step">
              <div class="step-time">${departureBus.time}</div>
              <div class="step-location">${busStopNames[departureBus.busStop]}</div>
            </div>
            <div class="itinerary-connector">
              <div class="connector-icon">ğŸšŒ</div>
              <div class="connector-text">${departureBus.route} ä¸Šå¤§å²¡è¡Œ</div>
            </div>
            <div class="itinerary-step">
              <div class="step-time">${departureBus.arrivalTime}</div>
              <div class="step-location">ä¸Šå¤§å²¡é§… åˆ°ç€</div>
            </div>
            <div class="itinerary-connector">
              <div class="connector-icon">${waitTimeMin}åˆ†</div>
              <div class="connector-text">ä¹—ã‚Šæ›ãˆ</div>
            </div>
            <div class="itinerary-step">
              <div class="step-time">${connectingBus.time}</div>
              <div class="step-location">ä¸Šå¤§å²¡é§… ç™ºè»Š</div>
            </div>
            <div class="itinerary-connector">
              <div class="connector-icon">ğŸšŒ</div>
              <div class="connector-text">${connectingBus.route}</div>
            </div>
            <div class="itinerary-step">
              <div class="step-time">${connectingBus.arrivalTime}</div>
              <div class="step-location">å¤æ³‰ åˆ°ç€</div>
            </div>
          </div>
        `;
      } else {
        nextBusResultDiv.innerHTML = `
          <div style="text-align: center;">
            <div class="departure-time-main">çµ‚äº†</div>
            <div class="time-remaining-direct">æœ€é©ãªæ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        `;
      }
    }

    function displayDirectBusInfo() {
      if (nextBusFromKamiooka) {
        const secondBusHTML = secondBusFromKamiooka ? `
          <div class="second-bus">
            <div class="second-bus-info">
              <span>ãã®æ¬¡ã¯:</span>
              <span class="second-bus-time">${secondBusFromKamiooka.time} ç™º</span>
              <span>(${busStopNames[secondBusFromKamiooka.busStop]} / ${secondBusFromKamiooka.route})</span>
            </div>
            <div class="second-countdown" id="second-countdown"></div>
          </div>
        ` : `<div class="second-bus">ã“ã‚ŒãŒæœ€çµ‚ãƒã‚¹ã§ã™</div>`;
        
        nextBusResultDiv.innerHTML = `
          <div style="text-align: center;">
            <div class="departure-time-main">${nextBusFromKamiooka.time}</div>
            <div class="time-remaining-direct" id="main-countdown"></div>
            <div class="details-direct">
              <span class="detail-tag">${busStopNames[nextBusFromKamiooka.busStop]}</span>
              <span class="detail-tag">${nextBusFromKamiooka.route}</span>
            </div>
            <hr class="divider">
            ${secondBusHTML}
          </div>
        `;
      } else {
        nextBusResultDiv.innerHTML = `
          <div style="text-align: center;">
            <div class="departure-time-main">çµ‚äº†</div>
            <div class="time-remaining-direct">ãŠç–²ã‚Œæ§˜ã§ã—ãŸ</div>
          </div>
        `;
      }
    }
    
    function updateCountdowns() {
      const now = new Date().getTime();
      let busToTrack;
      
      if (currentMode === 'to_kamiooka') {
        busToTrack = optimalPair ? optimalPair.departureBus : null;
        const countdownEl = document.getElementById('main-countdown');
        if (busToTrack && countdownEl) {
          const diff = busToTrack.departureTimestamp - now;
          if (diff < 0) {
            findAndDisplay();
            return;
          }
          countdownEl.textContent = formatRemainingTime(diff);
        }
      } else {
        busToTrack = nextBusFromKamiooka;
        const secondCountdownEl = document.getElementById('second-countdown');
        if (secondBusFromKamiooka && secondCountdownEl) {
          secondCountdownEl.textContent = `ã‚ã¨ ${formatRemainingTime(secondBusFromKamiooka.departureTimestamp - now, true)}`;
        }
        const countdownEl = document.getElementById('main-countdown');
        if (busToTrack && countdownEl) {
          const diff = busToTrack.departureTimestamp - now;
          if (diff < 0) {
            findAndDisplay();
            return;
          }
          countdownEl.textContent = formatRemainingTime(diff);
        }
      }
    }

    function formatRemainingTime(ms, simple = false) {
      const totalSeconds = Math.round(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      
      if (minutes < 1 && totalSeconds <= 10) return "ã¾ã‚‚ãªãç™ºè»Š";
      if (minutes < 1) return `ã‚ã¨ ${seconds} ç§’`;
      if (simple) return `${minutes}åˆ†`;
      return `ã‚ã¨ ${minutes}åˆ† ${String(seconds).padStart(2, '0')}ç§’`;
    }
    
    function displayKamiookaBusList() {
      const now = new Date().getTime();
      const upcomingBuses = allBusData.filter(bus => 
        bus.busStop === 'kamioooka' && bus.departureTimestamp >= now
      );
      
      if (upcomingBuses.length > 0) {
        upcomingBusesResultDiv.innerHTML = upcomingBuses.map(bus => `
          <div class="bus-item">
            <div class="bus-time">${bus.time} ç™º</div>
            <div class="bus-route">${bus.route}</div>
          </div>
        `).join('');
      } else {
        upcomingBusesResultDiv.innerHTML = `
          <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            æœ¬æ—¥ã®ãƒã‚¹ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚
          </p>
        `;
      }
    }
    
    // Event listeners
    const backToTopButton = document.getElementById('backToTopButton');
    
    busStopButtons.forEach(button => {
      button.addEventListener('click', () => {
        busStopButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentStopId = button.dataset.stop;
        displayUpcomingBuses();
      });
    });
    
    routeFilterButtons.forEach(button => {
      button.addEventListener('click', () => {
        routeFilterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentRouteFilter = button.dataset.route;
        displayUpcomingBuses();
      });
    });
    
    function displayUpcomingBuses() {
      if (!currentStopId) return;
      
      const now = new Date().getTime();
      let upcomingBuses = allBusData.filter(bus => 
        bus.busStop === currentStopId && bus.departureTimestamp >= now
      );
      
      if (currentRouteFilter !== 'all') {
        upcomingBuses = upcomingBuses.filter(bus => bus.route === currentRouteFilter);
      }
      
      upcomingBusesResultDiv.innerHTML = "";
      upcomingBusesResultDiv.classList.add('fade-in');
      
      if (upcomingBuses.length > 0) {
        upcomingBuses.forEach(bus => {
          const busItem = `
            <div class="bus-item">
              <div class="bus-time">${bus.time} ç™º</div>
              <div class="bus-route">${bus.route}</div>
            </div>
          `;
          upcomingBusesResultDiv.innerHTML += busItem;
        });
      } else {
        upcomingBusesResultDiv.innerHTML = `
          <p style="color: var(--text-muted); text-align: center; padding: 20px;">
            æ¡ä»¶ã«åˆã†ãƒã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>
        `;
      }
    }
    
    // Scroll to top functionality
    window.onscroll = () => {
      if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        backToTopButton.style.display = "block";
      } else {
        backToTopButton.style.display = "none";
      }
    };
    
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  </script>
</body>
</html>
